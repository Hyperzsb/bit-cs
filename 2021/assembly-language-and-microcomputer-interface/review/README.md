# 汇编语言与接口技术复习提纲

## 微型计算机硬件系统

### 微处理器

- 微处理器概述
- 80x86 系列 CPU 发展
- CPU 的微结构
- 微处理器性能指标：
  - 速度指标：
    - 主频也称时钟频率，表示在 CPU 内数字脉冲震荡的速度。主频越高，一个时钟周期内完成的指令数也越多，CPU 运算速度也就越快，执行程序的时间就能缩短。但由于微处理器内部结构不同，并非所有时钟频率相同的 CPU 性能也一样
    - 外频是系统总线的工作频率，即 CPU 与周边设备传输数据的频率。目前绝大部分计算机系统中外频也是内存与主板之间同步运行的速度；外频越高，CPU 就可以同时接收更多的来自外围设备的数据，从而使整个系统的速度进一步提高
    - 倍频是指 CPU 和系统总线之间工作频率相差的倍数；当外频不变时，倍频越高，CPU 的主频也就越高
  - 高速缓冲寄存器
  - 制造工艺
  - 核心电压
  - 封装形式
- 微处理器软件特性：
  - 工作模式：
    - CPU 工作模式指各种影响 CPU 可以执行的指令和芯片功能的操作环境。不同的工作模式决定了 CPU 如何管理内存
    - 实模式
    - 保护模式
    - 虚拟实模式
  - 指令系统
  - 超线程技术
  - 超标量和超长指令字
  - 动态执行技术
- 多核技术

### 主板

- 主板结构
- 芯片组
- 主板插槽
- 外部接口

### 内存

- 基本概念
- 存储器访问
  - 大端方案
  - 小端方案

### 扩展卡

- 显卡
- 网卡
- 声卡

## 微处理器管理模式

### 微处理器的基本结构

### CPU 工作模式

- 实模式
- 保护模式
- 虚拟8086模式
- 64位 CPU 的工作模式

### 寄存器

- 程序可见寄存器：
  - 通用寄存器：
    - 寄存器长8位、16位、32位和64位
    - RAX
    - RBX
    - RCX
    - RDX
    - RBP：保存访问存储单元时的偏移地址
    - RDI：用于寻址串指令的目的操作数
    - RSI：用于寻址串指令的源操作数
  - 段寄存器：
    - 寄存器长16位
    - 在实模式下存储段的高16位地址
    - 在保护模式下存储段的段选择符
    - CS：指向当前代码段的基地址
    - DS：指向当前运行程序所使用的数据段
    - SS：指向当前堆栈的基地址
    - ES：指向当前运行程序所使用的附加数据段
    - GS：（80386以上）另外存放数据的存储段
    - FS：（80386以上）另外存放数据的存储段
  - 专用寄存器：
    - 指令指针寄存器 IP/EIP/RIP：指向程序的下一条指令
    - 堆栈指针寄存器 SP/ESP/RSP：堆栈指针，指向栈顶单元
    - 状态寄存器 FLAG/EFLAG/RFLAG：状态标志寄存器，用来指示微处理器状态并控制它的操作
      - D0：进位标志 CF（Carry Flag）
      - D2：奇偶标志 PF（Parity Flag）
      - D4：辅助进位标志 AF（Auxiliary Carry Flag）
      - D6：零标志 ZF（Zero Flag）
      - D7：符号标志 SF（Sign Flag）
      - D8：单步标志 TF（Trap Enable Flag）
      - D9：中断允许标志 IF（Interrupt Enbale Flag）
      - D10：方向标志 DF（Direction）
      - D11：溢出标志 OF（Overflow Flag）
      - D13～D12：I/O 特权级 IOPL（I/O Privilege Level）
      - D14：嵌套任务位 NT（Nest Task）
      - D15： RF（Resume Flag）
      - D17：V86 模式位 VM（Virtual 8086 Model）
      - D18：地址对齐检查位 AC（Alignment Check）
      - D19：虚拟中断标志 VIF（Virtual Interrupt Flag）
      - D20：虚拟中断挂起标志 VIP（Virtual Interrupt Pending）
      - D21：微处理器标识标志 ID（Identification）
- 保护模式下的寄存器：
  - 控制寄存器 CR0～CR3：
    - CR0：低五位是系统控制标志，被称为机器状态字 MSW
      - D0：保护模式允许标志 PE（Protection Model Enable）
      - D1：运算协处理器存在位 MP（Monitor Coprocessor Extension）
      - D2：仿真位 EM（Emulate Processor Extension）
      - D3：任务切换标志 TS（Task Switched）
      - D4：协处理器选择标志 ET（Extension Type）
      - D31：分页标志 PG（Paging Enable）
    - 分页机制中用到 CR3、CR2 和 CR0：
      - CR3：页目录基址寄存器 PDBR，高20位用于保存页目录表的起始物理地址的高20位（页目录是页对齐的）
      - CR2：页面故障线性地址寄存器
  - 调试和测试寄存器：
    - 80386提供8个32位的调试寄存器和8个32位的测试寄存器
  - 全局描述符表寄存器 GDTR：
    - 全局描述符表 GDT 是用来定义全局存储器空间的一种机制
    - 用段描述符来描述一个全局存储器中的段
    - 每个 CPU 核有一个 GDT
    - GDT 最多包含8192个描述符，每个描述符8B
    - GDT 可以存储在内存的任何位置，通过 GDTR 给出它的位置和大小
    - GDT 需要在进入保护模式之间通过 LGDT 指令装入 GDTR
    - GDTR 是48位寄存器：
      - 低16位：限长，比 GDT 的实际长度少1
      - 高32位：GDT 的基地址（线性地址，经过分页部件转换为物理地址）
  - 中断描述符表寄存器 IDTR：
    - 中断描述符表中存储的不是段描述符，而是中断门描述符
    - IDT 最多包含256个门描述符（CPU 最多支持256个中断），每个描述符8B
    - IDT 需要在进入保护模式之间通过 LIDT 指令装入 IDTR
    - IDTR 是48位寄存器：
      - 低16位：限长，比 IDT 的实际长度少1
      - 高32位：IDT 的基地址（线性地址，经过分页部件转换为物理地址）
  - 局部描述符表寄存器 LDTR：
    - 系统中除了一个公用的 GDT 外，还为每个任务建立一个局部描述符表 LDT，每个任务最多只能有一个 LDT
    - LDT 中只含有系统中某一个任务相关的各个段的描述符
    - LDT 最多包含8192个描述符，每个描述符8B
    - LDTR 并不直接给出 LDT 的位置和大小
    - LDTR 是一个16位的选择符，指向一个 LDT 描述符，而 LDT 描述符存储在 GDT 中
  - 任务寄存器 TR：
    - 任务寄存器在保护模式的任务切换机制中使用
    - TR 是16位的选择符，其内容为索引值，选中的是 TSS 描述符
    - TR 的初值由软件装入，当执行任务切换指令时，TR 的内容自动修改
  - 段选择符：
    - 段寄存器在实模式和 V86 模式下，兼容16位 CPU，即段寄存器保存20位段基址的高16位，段基址的低4位为0
    - 段寄存器在保护模式下，不直接存放段基址，而是存放段选择符。由段选择符从全局描述符表或局部描述符表中找到8个字长的段描述符
    - D1～D0：请求特权级 RPL，表示将要访问的段的特权级
    - D2：表指示符 TI。为0时，从 GDT 中选择描述符；为1时，从 LDT 中选择描述符
    - D15～D3：索引，指出要访问描述符在段描述符表中的顺序号。需要乘以8

### 内存管理

- 实模式下分段管理：
  - 8086/8088 CPU 有20位地址总线，可以寻址1MB 的空间
  - 段寄存器中存放段基址高16位，低4位为0
- 保护模式下分段管理：
  - 段描述符
  - 段的属性
  - 段描述符高速缓存
  - 段式地址转换
- 页式内存管理：
  - 分页
  - 线性地址到物理地址的映射过程
  - 片内转换检测缓冲器
  - 页表项
  - 线性地址转换为物理地址实例

### 任务

- 任务执行环境
- 任务状态段：
  - TSS 描述符属于系统描述符，它必须放在 GDT 中，而不能放在 IDT 或 LDT 中
- 门：
  - 调用门、任务门、中断门、陷阱门
  - 门描述符：
    - 属于系统描述符
  - 调用门：
    - 调用门可以实现当前任务从低特权级到高特权级的间接控制转移
    - 可以在 GDT 中，也可以在 LDT 中
    - CALL X:Y 中，X 是一个选择符，指向了一个调用门描述符，Y无意义
    - 通过调用门中的段选择符找到被调用段的基址，而入口点的偏移量就是调用门描述符中的偏移量
  - 任务门：
    - 任务门的选择符必须指向 GDT 中的任务状态段 TSS 段描述符，门中的偏移量无意义，任务的入口点在保存在 TSS 中
- 任务切换：
  - 直接任务切换：直接选中 GDT 中的 TSS
  - 间接任务切换：通过任务门选中 GDT 中的 TSS

### 保护

- 数据访问保护
- 对程序的保护
- 输入输出保护

## 指令系统

### 数据寻址方式

- CPU 操作数寻址：
  - 立即寻址方式（立即数寻址方式）：
    - 操作数直接包含在指令中，紧跟在操作码之后的寻址方式
    - 只能出现在源操作数的位置
  - 寄存器寻址方式：
    - 操作数直接包含在寄存器中，由指令指定寄存器
    - 目标寄存器不能是 CS
    - 既可以出现在源操作数位置，也可以出现在目标操作数位置
- 存储器操作数寻址：
  - 直接寻址方式：
    - 操作数的有效地址（Effective Address，EA）直接包含在指令中的寻址方式，直接从指令码中取出，而不必经过计算或其它操作
    - EA 就是操作数地址的偏移量部分，其物理地址是通过把有效地址与段基址相加得到
    - 对于内存分段管理情况，若工作在实模式下，段基址为段寄存器的内容乘以16得到的值；若工作在保护模式，则通过段寄存器（存放段选择符）中的描述索引，从描述符表中得到描述符，再从描述符中得到段基址
    - 允许使用段超越前缀
  - 寄存器间接寻址方式：
    - 操作数的有效地址在寄存器而操作数本身在存储器中的寻址方式
    - 对于16位寻址，这个寄存器只能是基址寄存器 BX、BP 或变址寄存器 SI、DI；对于32位寻址，允许使任何32位通用寄存器
    - 若指令中使用的是 BP、EBP、ESP 之外的寄存器，则默认操作数在数据段，即它们默认与 DS 段寄存器配合；否则默认操作数在数据段，即它们默认与 SS 段寄存器配合
    - 允许使用段超越前缀
  - 寄存器相对寻址方式：
    - 操作数的有效地址是一个寄存器的内容和指令中给定的一个位移量之和
    - 对于16位寻址，这个寄存器只能是基址寄存器 BX、BP 或变址寄存器 SI、DI；对于32位寻址方式，允许使用任何32位通用寄存器
    - 位移量可以是8位、16位、32位（只适用于32位寻址）的带符号数
    - 若指令中使用的是 BP、EBP、ESP 之外的寄存器，则默认操作数在数据段，即它们默认与 DS 段寄存器配合；否则默认操作数在数据段，即它们默认与 SS 段寄存器配合
    - 可以用来访问一维数组
    - 允许使用段超越前缀
  - 基址变址寻址方式：
    - 对于16位寻址，操作数的有效地址是一个基址寄存器（BX、BP）和一个变址寄存器（SI、DI）的内容之和；对于32位寻址，允许使用变址部分除了 ESP 以外的任何两个32位通用寄存器组合
    - 若指令中使用的基址寄存器的是 BP、EBP、ESP 之外的寄存器，则默认操作数在数据段，即它们默认与 DS 段寄存器配合；否则默认操作数在数据段，即它们默认与 SS 段寄存器配合
    - 允许使用段超越前缀
  - 相对基址变址寻址方式：
    - 对于16位寻址，操作数的有效地址是一个基址（BX、BP）和一个变址寄存器（SI、DI）的内容与指令中给定的一个位移量之和；对于32位寻址，允许使用变址部分除了 ESP 以外的任何两个32位通用寄存器及一个位移量的组合
    - 位移量是8位、16位、32位（只适用于32位寻址）的带符号数
    - 若指令中使用的基址寄存器的是 BP、EBP、ESP 之外的寄存器，则默认操作数在数据段，即它们默认与 DS 段寄存器配合；否则默认操作数在数据段，即它们默认与 SS 段寄存器配合
    - 可以访问二维数组
    - 允许使用段超越前缀
  - 比例变址寻址方式：
    - 80386以上的微处理器提供
    - 操作数的有效地址由以下几部分相加得到：
      - 基址部分：8个32位通用寄存器
      - 变址部分：除了 ESP 以外的32位通用寄存乘以比例因子；比例因子可以是1（默认）、2、4或8
      - 位移量：可以是8位、32位的带符号数
    - 若指令中使用的基址寄存器的是 EBP、ESP 之外的寄存器，则默认操作数在数据段，即它们默认与 DS 段寄存器配合；否则默认操作数在数据段，即它们默认与 SS 段寄存器配合
    - 允许使用段超越前缀

### 数据运算指令

- 传送指令 MOV：

  - 格式：`MOV DST, SRC`
  - 功能：SRC（源） -> DST（目标）
  - 说明：MOV 指令可以实现一个字节、一个字、一个双字的数据传送，注意源操作数和目标操作数的数据类型匹配问题，即应同为字节、字或双字型数据
  - MOV 指令可实现的数据传送方向： :book:
    - 立即数不能作为目标操作数
    - 立即数不能直接送段寄存器
    - 目标寄存器不能是 CS，因为随意修改 CS 会引起不可预料的结果
    - 两个段寄存器间不能直接传送
    - 两个存储单元之间不能直接传送
    - 在将立即数写入存储器中时，必须指明指向的内存单元的类型

- 栈基地址放在 SS 堆栈段寄存器中，栈顶地址放在 SP 或 ESP 堆栈指针寄存器中，SP 或 ESP 始终指向栈顶。堆栈主要用于对现场数据的保护和恢复、子程序与中断服务返回地址的保护与恢复等

- 进栈指令 PUSH：

  - 格式：`PUSH SRC`

  - 功能：先修改堆栈指针，使其指向新的栈顶（若 SRC 是16位操作数，则堆栈指针减2，若 SRC 是32位操作数，则堆栈指针减4），然后把 SRC 压入栈顶单元
  - 说明：在8086、8088中，SRC 只能是16位寄存器操作数或存储器操作数，不能是立即数；在80286以上的机器中，允许立即数
  - 若堆栈的空间不够大，可能会导致栈溢出

- 出栈指令 POP：

  - 格式：`POP DST`
  - 功能：先把堆栈指针所指向单元的内容弹出到 DST，然后修改指针以指向新的栈顶（若 SRC 是16位操作数，则堆栈指针加2，若 SRC 是32位操作数，则堆栈指针加4）
  - 说明：DST 可以是16位或32位的寄存器操作数和存储器操作数，也可以是除 CS 寄存器以外的任何段寄存器

- 输入指令 IN：

  - 格式：`IN ACR, PORT`
  - 功能：把外设端口（PORT）的内容传送给累加器
  - 说明：
    - 可以传送8位、16位、32位（80386以上）的数据，相应的累加器选择 AL、AX、EAX
    - 若端口号在0～255之间，则端口号直接写在指令中；若端口号大于255，则端口号通过 DX 寄存器间接寻址，即端口号应先放入 DX 中

- 输出指令 OUT：

  - 格式：`OUT PORT, ARC`
  - 功能：把累加器的内容传送给外设端口
  - 说明：对累加器和端口号的选择限制与 IN 指令相同

- 地址传送指令 LEA：

  - 格式：`LEA REG, SRC`
  - 功能：把源操作数的有效地址送给指定的寄存器
  - 说明：源操作数必须是存储器操作数

- 16位标志进栈指令 PUSHF：

  - 格式：`PUSHF`

  - 功能：先使堆栈寄存器 SP 减2，然后压入标志寄存器 FLAGS 的内容到栈顶单元

- 16位标志出栈指令 POPF：

  - 格式：`POPF`
  - 功能：先把栈顶指针所指向的字弹出到 FLAGS，然后是堆栈指针寄存器 SP 加2

- 加法指令 ADD：

  - 格式：`ADD DST, SRC`
  - 功能：(DST) + (SRC) -> DST
  - 说明：
    - 对于操作数的限定同 MOV 指令，即源和目标均可以是8位、16位、32位的操作数
    - 要注意源和目标操作数的类型匹配，即它们的长度要一致
    - 目标不能是立即数和 CS 段寄存器
    - 两个操作数不能同时为存储器操作数
  - 标志：影响 OF、SF、ZF、AF、PF、CF 标志

- 带进位加法指令 ADC：

  - 格式：`ADC DST, SRC`
  - 功能：(DST) + (SRC) + CF -> DST
  - 说明：
    - 除了执行时要加标志 CF 的值外，其他要求同 ADD
    - 因为它考虑了 CF，所以可以用于数值是多字节或多字的加法程序

- 加1指令 INC：

  - 格式：`INC DST`
  - 功能：(DST) + 1 -> DST
  - 说明：使用本指令可以很方便地实现地址指针或循环次数的加1修改
  - 标志：不影响 CF 标志，影响其他5个算数运算特征标志

- 减法指令 SUB：

- 带借位减法指令 SBB：

- 减1指令 DEC：

- 比较指令 CMP：

- 无符号数乘法指令 MUL：

- 无符号数除法指令 DIV：

- 逻辑运算指令：

- 基本移位指令：

### 程序控制指令

- 转移指令的寻址方式：
  - 段内直接寻址方式：
    - 短转移
    - 近转移
  - 段内间接寻址方式
  - 段间直接寻址方式
- 转移指令：
  - 无条件转移指令：
    - 段内转移：
      - 段内直接短转移
      - 段内直接近转移
      - 段内间接转移
    - 段间转移：
      - 段间直接转移
      - 段间间接转移
  - 条件转移指令：
    - 检测单个条件标志位转移指令
    - 根据两个带符号数比较结果实现转移的条件转移指令
    - 根据两个无符号数比较结果实现转移的条件转移指令
- 循环指令：
  - 循环指令
- 子程序调用与返回指令：
  - 子程序调用指令：
    - 段内调用：
      - 段内直接调用
      - 段内间接调用
    - 段间调用：
      - 段间直接调用
      - 段间间接调用
  - 子程序返回指令：
    - 返回指令
    - 带立即数的返回指令

### 处理机控制指令

- 标志操作指令：只影响本指令所涉及的标志
  - CLC（Clear Carry）：把进位标志 CF 清0
  - STC（Set Carry）：把进位标志 CF 置1
  - CMC（Complement Carry）：把进位标志 CF 取反
  - CLD（Clear Direction）：把方向标志 DF 清0
  - STD（Set Direction）：把方向标志 DF 置1
  - CLI（Clear Interrupt）：把中断允许标志 IF 清0
  - STI（Set Interrupt）：把中断允许标志 IF 置1

### 块操作指令

- 利用块操作指令可以直接处理两个存储器操作数，从而可以方便地处理字符串和数据块

## 汇编语言程序开发

### 汇编语言基本知识

- 汇编语言概述
- 汇编语言编程环境
- 汇编语言语句格式

### 常用伪指令 :book:

- 数据定义伪指令：

  - 用于定义程序中使用的数据
  - 功能：为变量分配单元，并为其初始化或者只预留空间
  - 说明：
    - 变量名是可选的，需要时由用户自己定义。它是数据区的符号地址，也是其中第一个数据项的偏移量。程序通过变量名引用其中的数据
    - 助记符是数据类型的符号表示，不区分大小写
    - 操作数可以是数字常量，数值表达式，字符串常量，地址表达式，`?`、`<n>DUP(操作数)` 等形式
  - 变量名+/-数字表示直接寻址（结果是地址），不是把变量中的内容进行加减操作

- 符号定义伪指令：

  - 等值伪指令 EQU：
    - 程序中有时会多次出现同一个表达式，为方便起见，可以用符号定义伪指令给该表达式定义一个符号，以便于引用及减少程序修改量，并提高程序可读性。汇编后，该符号代表一个确定的值，该符号定义的伪指令称为等值伪指令
    - 功能：用符号名代表表达式或表达式的值
    - 说明：
      - 表达式可以是任何有效的操作数格式。它可以是常数、数值表达式、另一符号名或助记符
      - 用 EQU 定义的符号在同一个程序中不能再定义
    - 还可以同 $ 操作符配合，得到变量分配的字节数
  - 等号伪指令 =：
    - 功能：用符号名代替数值表达式的值
    - 说明：
      - 与 EQU 伪指令功能相似，区别是等号伪指令的表达式只能是常数或数值表达式；另外被定义的符号可以再次被定义
      - 通常在程序中使用它定义常数

- 操作符伪指令：

  - $ 操作符：
    - 功能：$ 在程序中表示当前地址计数器的值。程序中的每一行都有一个地址，从程序的第一行到最后一行，地址计数器在不断的增加；如果一行语句占用了存储空间，如定义变量或指令，则地址计数器就会增加，增加的字节数就是变量或指令所占的字节数
    - 说明：程序中一般不直接使用 $ 的值，而是使用它来计算变量占用的空间
  - ORG 操作符：
    - 功能：设置地址计数器内容为数值表达式的值
    - 说明：在汇编程序对源程序汇编的过程中，使用地址计数器保存当前正在汇编的语句地址（段内偏移量），允许使用 ORG 修改这个值
  - OFFSET 操作符：
    - 功能：OFFSET 操作符用来取出变量或标号的地址（段内偏移量）。在32位编程环境中，地址是一个32位的数
  - 算术操作符：
    - 包括 + / - / * / / / MOD
    - 说明：算术操作符的结果是常量，计算过程是程序被编译时（不是在运行时）完成的
  - 逻辑操作符：
    - 包括 AND / OR / XOR / NOT
    - 说明：
      - 按位操作，在编译时被完成
      - 只能用在数值表达式中
  - 关系操作符：
    - 包括 EQ / NE / LT / LE / GT / GE
    - 说明：
      - 比较结果为真时，返回结果的全部二进制为1；比较0结果为假时，返回结果的全部二进制位为0
      - 操作数必须为常数或常数表达式
      - 在程序编译时完成

- 框架定义伪指令：

  - 微处理器伪指令：

    - 说明本程序使用哪一种 CPU 的指令集。汇编程序在默认情况下只接受 8086 的指令系统。为了能够使用其它微处理器或协处理器的指令系统编写元件，需要在程序中增加选择微处理器的伪指令
    - 对照表 :book:
    - 一般32位汇编语言程序使用80386指令集即可，即 `.386`
    - 如果用汇编语言编写的是驱动程序或者驱动程序的一个小模块，因为驱动程序是在特权级0上运行的，因此需要使用 `.386p`

  - 框架定义伪指令：

    - 对照表：

      | 伪指令格式  |                             功能                             |
      | :---------: | :----------------------------------------------------------: |
      |    .DATA    |                          定义数据段                          |
      |   .DATA?    |                 定义存放未初始化变量的数据段                 |
      |   .CONST    |                     定义存放常量的数据段                     |
      |    .CODE    |                          定义代码段                          |
      |  .STARTUP   |                    指定加载后的程序入口点                    |
      |    .EXIT    |                      返回 DOS 或父进程                       |
      | .STACK size | 建立一个堆栈段并定义其大小（size 以字节为单位，若不指定参数，则使用默认值1KB） |
      |   .MODEL    |                      指定程序工作的模式                      |

    - 在 Windows 中，实际上只有代码区和数据区之分，.DATA、.DATA?、.CONST、.STACK 都视为数据区

    - 当 .386 等选择微处理器器伪指令出现在 .MODEL 伪指令之前时，不能使用 .STARTUP 和 .EXIT，否则汇编时会出错

### 汇编源程序格式

- 用户界面
- 控制台界面的汇编源程序：
  - 模式定义：
    - Windows 中，模式定义部分需要指定调用规则，Windows API 使用 stdcall，故一般选用 stdcall
  - includelib 语句：
    - 静态链接
    - 动态链接：DOS 不支持动态链接，只能使用静态链接；Windows 都可以
  - 函数声明语句
  - include 语句：
    - 对于所有要用到的库函数及 Windows API 函数，在程序的开始部分都必须预先声明，这样显然比较麻烦。在汇编语言编程中，可以采用 C 语言的办法，就是把所有的函数声明及常量定义等公用部分预先放在一个头文件中
  - 数据和代码部分
  - 程序结束：
    - 与 DOS 程序相同，Win32 程序在遇到 end 语句时结束
  - 跨行语句
  - 程序中的数据归类：
    - 可读可写的已定义初始变量
    - 可读可写的未定义初始变量
    - 常量数

### 分支与循环程序设计

- 分支程序设计：
  - IF_THEN_ELSE 结构分支程序设计
  - SWITCH_CASE 结构分支程序设计：
    - 需要一个地址表（跳转表）
- 循环程序设计：
  - 单重循环程序设计：
    - LOOP 指令：使用 CX 或者 ECX 存储循环次数；自动完成循环次数的修改和条件的判断
  - 多重循环程序设计

### 浮点运算 :book:

- 浮点数的表示与存储
- 浮点寄存器：
  - 浮点寄存器栈：
    - FPU 不使用通用寄存器，FPU 在执行浮点运算时有自己的一组寄存器，称为寄存器栈；寄存器栈是循环栈
    - 寄存器栈由8个独立寻址的80位寄存器构成，称为 FPR0、FPR1......在指令中也写作 ST(0)、ST(1)......
    - ST(i) 其中 i 不是寄存器的地址，而是距离栈顶的长度
  - 标志寄存器：
    - 每个 FPR 寄存器，都有一个两位的标志位，共组成一个16位的标志寄存器
    - 用于说明每个 FPR 中是否有数据
  - 状态寄存器：
    - 状态寄存器16位，表明浮点处理单元当前的各种操作状态
    - 每条浮点指令运算后，都会更新状态寄存器，以反映执行结果情况
  - 控制寄存器：
    - 16位浮点控制寄存器用于控制浮点处理单元的异常屏蔽、精度及舍入操作
- 浮点指令及其编程 :memo:

### 程序优化

- 运行时间优化：
  - 选择执行速度快的指令：
    - 寄存器清零：应使用 SUB 或者 XOR 指令
    - 加减：使用 LEA 命令
    - 乘除：使用 LEA 命令
  - 操作的转化：使用特殊方式将除法转换为乘法 :book:
  - 分支的转化：使用特殊的方式将求较小值和求较大值采用非分支的方式进行 :book:
  - 提高 Cache 命中率
- 占用空间优化：
  - 短指令
  - 联合

## 子程序设计

### 子程序基本知识

- 子程序定义：
  - 寄存器的保存与恢复：在开头保存将要使用的寄存器内容，返回时再恢复他们，以保证调用程序的寄存器内容不被破坏，通常使用 PUSH 指令，使用 POP 指令恢复；弹出的顺序应该与压入时相反
  - 保持堆栈平衡：当执行子程序的 RET 指令时，从堆栈弹出的数据应该正好是由响应的 CALL 指令压入的值
  - 子程序说明
- 堆栈：
  - 堆栈的特性：
    - 临时性
    - 快速性
    - 动态扩展性
  - 堆栈的用途：
    - 保护和恢复调用现场
    - 用于变量之间的数据传递
    - 用作临时的数据区
    - 子程序的调用和返回
  - 子程序的返回地址

### 参数传递

- 在主程序和子程序中传递参数的方法：
  - 通过寄存器传递：不能被递归
  - 通过数据区变量传递：不能被递归
  - 通过堆栈传递
- C 语言函数的参数传递方式：
  - cdecl 方式：
    - 参数从右至左进栈；参数出栈由主程序完成；参数的个数可以动态变化
    - 该方式是 C 函数的默认方式，不加说明时，函数就使用 cdel 调用规则
    - 最后一个参数先入栈，每一个参数压栈一次，在堆栈中占4字节
    - 在子程序中，使用 `[EBP+X]` 的方式来访问参数。`X=8` 代表第一个参数
    - 程序用 RET 指令返回
    - 由主程序执行 `ADD ESP, n` 的堆栈平衡指令，其中 n 等于参数个数乘以4
    - 子程序的返回值放在 EAX 中
  - stdcall 方式：
    - Windows API 采用该规则
    - 堆栈平衡的工作时由子程序来完成的
    - 子程序使用 `RET n`，在返回主程序的同时平衡 ESP，其中 n 等于参数个数乘以4
    - 子程序的返回值放在 EAX 中
  - fastcall 方式：
    - 和 stdcall 类似
    - 使用 ECX 传递第一个参数，使用 EDC 传递第二个参数
    - 堆栈平衡的工作时由子程序来完成的
    - 子程序使用 `RET n`，在返回主程序的同时平衡 ESP，其中 n 等于参数个数乘以4
  - this 方式：
    - 同 stdcall 方式类似
    - 在 C++ 的成员函数中使用，使用 ECX 传递 this 指针，即指向对象
    - 堆栈平衡的工作时由子程序来完成的
  - naked 方式
    - 前面几种方式编译器会自动为函数生成进入代码和退出代码
    - 该方式需要编程者自行编写函数内的所有代码
- 汇编语言子程序的参数传递方式
- 带参数子程序的调用：
  - INVOKE 伪指令：该伪指令后面跟的参数必须直接能够作为 PUSH 指令的源操作数，因此不能是表达式
  - 在程序中不能随意修改 EBP 的值，EBP 用来访问位于堆栈中的参数
- 子程序中的局部变量：
  - LOCAL 伪指令
  - ADDR 和 OFFSET：如果在子程序中定义了局部变量，而在 INVOKE 语句中使用这个局部变量的地址，就需要用到 ADDR 伪操作符，而不能使用 OFFSET 伪操作符。OFFSET 后面只能跟全局变量（即在数据区定义的变量）和程序中的标号，不能跟局部变量

### 子程序的特殊应用

- 子程序嵌套
- 子程序递归
- 缓冲区溢出：
  - 堆栈溢出
  - 数据区溢出
- 模块化程序设计

### 模块化程序设计

- 模块化设计基本概念
- 模块间通信：
  - 外部引用伪指令：EXTERN
  - 全局富豪说明伪指令：PUBLIC
  - 子程序声明伪指令：PROTO

### C 语言模块的反汇编

- 基本框架
- 选择结构
- 循环结构
- 变量定义
- 指针
- 函数

### C 语言和汇编语言的混合编程

## 存储系统与技术

### 高速缓冲存储器

- Cache 工作原理：
  - 局部性原理：
    - 时间局部性
    - 空间局部性
  - Cache 的访问结构：
    - 贯通查找式
    - 旁路读出式
  - Cache 映射：
    - 全相联映像
    - 直接映像
    - 组相联映像
  - Cache 替换策略：
    - FIFO、LRU
  - 微机中的 Cache：
    - L1 采用哈佛结构
    - 追踪缓存
- Cache 的一致性协议：
  - 单核 CPU 一致性处理：
    - 写直达法
    - 写回法
  - 多核 CPU 的 MESI 协议 :memo:

### 内部存储器

- 内存分类：
  - RAM：
    - 双极型
    - MOS 型：
      - SRAM
      - DRAM
  - ROM：
    - 掩模型 （MROM）
    - 可编程只读存储器（PROM）
    - 可编程可擦除只读存储器（EPROM）
    - 闪存（Flash Memory）
- 主要技术指标和参数：
  - 存储容量：
    - Bank：逻辑 Bank
    - 数据深度：位宽
    - 容量的表示方法：$存储单元数量=行数 \times 列数 \times 数据深度 \times Bank 的数量$
  - 内存带宽：
    - 内存的传输速度
    - 带宽：$带宽=总线宽度 \times 总线频率 \times 一个时钟周期内交换的数据包的个数$
    - 存储器的访存速度
    - 错误校验
- 内存模组：
  - 内存模组接口
  - 内存颗粒：
    - SDRAM：同步动态随机存储器；内存与系统总线速度同步；在一个时钟周期内传输一次数据
    - DDR：双倍速率同步动态随机存储器；一个时钟周期内传输两次数据
    - DDR2
    - DDR3
    - DDR4
  - SPD 芯片
- 辅助存储器：
  - 硬盘概述：
    - 磁盘面（柱面）：盘面号从0开始
    - 磁道：磁道号从0开始
    - 扇区：扇区号从1开始
  - HDD 主要技术指标：
    - 容量
    - 转速
    - 缓存
    - 时间相关参数：
      - 平均寻道时间
      - 平均潜伏时间
      - 平均访问时间
    - 数据传输率：
      - 突发数据传输率：即微机系统与硬盘缓冲区之间的数据传输率；同接口类型和缓冲区容量大小相关
      - 持续传输率：反应缓冲区未用时的速度；同硬盘转速相关
    - 接口类型
  - ATAPI 标准：
    - ATA 总线
    - ATA 接口及其发展
  - ATA 接口的编程模型：
    - 扇区的编址模式：:memo:
      - LBA 编址模式
      - CHS 编址模式
    - PATA 接口的传输模式：
      - PIO 模式：即程序控制 I/O 模式
      - DMA 模式
  - ATA 设备寄存器：
    - 可编程 ATA 寄存器地址
    - 可编程 ATA 寄存器定义
  - 硬盘读写方式：
    - PIO 方式读写硬盘
    - DMA 方式读写硬盘
  - 串行 ATA
    - SATA 接口和技术指标
    - AHCI 技术
    - NCQ 技术：支持 NCQ 技术的硬盘在接到读写指令后，根据指对访问地址进行重新排序，减少读取时间，使数据传输率更为高效，同时也能有效延长磁盘的使用寿命
  - 固态硬盘：
    - 优点：
      - 速度快
      - 读取时间相对固定
      - 无噪声、不会发生机械故障
      - 工作温度范围更大
    - 缺点：
      - 成本高
      - 容量低
      - 写入寿命有限
      - 数据损坏后难以恢复

## 总线技术

### 总线概述

- 总线定义：
  - 总线是一种通讯通道，用以在计算机内部及计算机之间传输数据；现在泛指任何能够提供通讯逻辑功能的物理布局和设施
- 总线分类：
  - 按所处的位置分：
    - 片内总线
    - 片外总线
  - 按功能分：
    - 地址总线
    - 数据总线
    - 控制总线
  - 按信息的传送方向分：
    - 单向总线
    - 双向总线
  - 按层次结构分：
    - CPU 总线
    - 存储总线
    - I/O 通道总线
  - 按通信方式分：
    - 并行总线
    - 串行总线
  - 按时钟信号方式分：
    - 同步总线
    - 异步总线
- 总线的技术指标：
  - 总线的带宽：也称数据传输速率，指的是单位时间内总线上传输的数据量，即每秒钟传送的最大稳态数据量；$总线带宽=总线的工作频率 \times 总线的位宽 \div 8$
  - 总线的位宽：总线能同时传送的二机制数据的位数
  - 总线的工作频率

### PCI 总线

- 不依附于某个具体处理器的局部总线标准
- PCI 总线的特点：
  - 采用地址线和数据线复用方式
  - 允许32位与64位器件相互协作
- PCI 总线的体系结构
- PCI 总线引脚信号定义
- PCI 总线命令
- PCI 总线协议
- PCI 总线数据传输过程
- PCI 总线仲裁
- PCI 总线配置

### PCI-E 总线

- PCI-E 概述：
  - 每个设备都有自己的专用连接，不需要向整个总线请求带宽
  - 数据传输率提高到一个很高的频率，达到 PCI 所不能提供的高带宽
- PCI-E 的协议层次

### USB 总线

- USB 的起源和发展：	
  - USB：通用串行总线
  - 支持热插拔且即插即用
  - USB 总线的物理结构允许总线上挂接多个设备
  - 接口小、成本低
  - 性能可靠
- USB 接口的硬件特性：
  - ID 引脚：
    - 高电平时是从设备
    - 低电平时是主设备
- USB OTG 技术及其扩展：
  - USB OTG 技术：
    - OTG 技术就是在没有主设备的情情况下，实现从设备之间的数据传输
    - USB 装置就拜托了原来主从架构的限制，实现了端对端的传输模式
  - OTG 功能的构建：
    - OTG 协议：
      - 主机协商协议
      - 会话请求协议
      - 连接检测协议
  - OTG 功能的扩展：
    - ID 引脚承担更多功能，进行功能复用
- USB 通信协议：
  - USB 传输类型：
    - 控制传输：用来支持外设与主机之间的控制、状态、配置等信息的传输，为外设与主机之间提供控制通道
    - 同步传输：支持具有一定周期性、有限的时延和带宽，且数据传输率不变的外设与主机之间的数据传输
    - 中断传输：支持游戏手柄、鼠标和键盘等输入设备，这些设备与主机间数据传输量小，无周期性，但对响应时间敏感，要求立即响应
    - 数据块传输：支持打印机、扫描仪、数码相机等外设，这些外设与主机间传输的数据量大，USB 在满足带宽的情况下才进行该类型的数据传输
  - USB 描述符：
    - USB 协议为 USB 设备定义了一套描述设备功能和属性的具有固定结构的描述符，由特定格式排列的一组数据结构组成
  - USB 设备类型

### I2C 总线

- I2C 概述：
  - 两线式串行总线：
    - 串行数据线 SDA：用于数据发送和接收
    - 串行时钟线 SCL：用于数据同步
  - 每个连接到总线的器件都可以通过唯一的地址和一直存在的简单的主机/从机关系软件设定地址，主机可以作为主机发送器或主机接收器
  - 真正的多主机总线
- I2C 接口访问 EEPROM

## 接口技术

### 串行接口及应用

- 串行通信概述：
  - 数据发送方将并行数据转换成按照二进制数据位排列的串行形式的数据送到传输线上。数据接收方的串行接口接收到这些二进制位后，再将它们转换成字节形式的并行数据
  - 信息在一个方向上传输只占用一根通信线，既作数据线，又作联络线
  - 数据传输方式：
    - 单工
    - 半双工
    - 全双工
  - 异步串行通信协议：
    - 无时钟信号，面向字符，传送不连续
    - 异步串行通信格式 :book:
    - 波特率和比特率
    - 时钟误差
    - 奇偶校验
  - 同步串行通信协议：
    - 接收双方同一个时钟信号，面向比特，传送连续
    - 面向字符的同步协议：被传送的数据块是由字符组成的，不像异步协议那样需要在每个字符前后附加起始和停止位，因此传输效率提高了
    - 面向比特的同步协议：所传输的一帧数据的长度可以是任意位，而且它是靠约定的位组合模式，而不是靠特定字符来标志帧的开始和结束
  - 调制和解调：
    - 调幅
    - 调频
    - 调相
  - RS-232C 标准
- 可编程串行通信接口：
  - UART 概述：通用异步收发传输器
  - 8250/16550功能和基本原理
  - 8250/16550的编程模型

### 定时与计数技术

- 定时与计数概述：
  - 定时器和计数器：
    - 定时器记录高精度晶振脉冲信号，可以输出准确的时间间隔
    - 计数器记录外设提供的具有一定随机性的脉冲信号的个数，进而获知外设的某种状态
  - 软件定时
  - 不可编程的硬件定时
  - 可编程的定时
- 可编程定时器芯片：:book:
  - 8254的内部结构：
    - 数据总线缓冲器
    - 读写逻辑
    - 控制字寄存器
    - 计数器
  - 8254的引脚
  - 8254的控制字及其编程：
    - 8254的方式控制字
    - 8254的编程：
      - 初始化：
        - 选地址
        - 若是16位计数值，先装入低8位，再装入高8位
      - 读取当前计数值：
        - 若是16位计数值，先读低8位，再读高8位
        - 锁存当前计数值的方法：
          - 利用 GATE 信号使计数过程暂停
          - 锁存一个计数器
          - 写读回命令锁存：
            - 若计数器的计数值和状态同时被锁存，则先读出计数器的状态，再读出计数器的计数当前值
  - 8254的六种工作方式：
    - 方式0（计数结束中断方式）：
    - 方式1（可编程单稳态触发器）：
    - 方式2（脉冲波发生器、分频器）：
    - 方式3（方波发生器）：
    - 方式4（软件触发选通方式）：
    - 方式5（硬件触发选通方式）：
  - 8254的应用：
    - 计数
    - 分频
    - 级联
- 微机系统中的定时：

### 红外

- 红外技术概述：
  - 光通信的一种，位于可见光之外的红外光区的电磁波。它可以实现数据的无线传输
  - 特征：
    - 点对点的传输方式
    - 无线，不能远距离传输，要直线互相对准且中间不能有障碍物，即不能阻碍红外光线传播
    - 提供较高的传输速率
    - 一个红外通信系统包括三个基本部分：发射机、信道和接收机
  - 按照红外传输的链路，分为：
    - 定向视距链路
    - 视距混合链路
    - 非定向视距链路
    - 漫反射链路
- IrDA 协议分析：
  - 红外物理层协议 IrPHY
  - 红外链路接入协议 IrLAP
  - 红外链路管理协议 IrLMP
- IrDA 建立连接的过程：
  - 设备发现和地址解析
  - 链接建立
  - 信息交换和链接复位
  - 链接终止

### Wi-Fi

- WLAN 的组成：
  - 工作站（STA）：是 WLAN 最基本的组成单元。也被称为无线终端，是集成了无线网络设备的计算机或智能设备终端
  - 无线接入点（AP）：可以是无线接入点，也可以是无线路由器，主要负责连接所有无线工作站进行集中管理、收发无线信号实现数据交换、实现无线工作站和有线局域网之间的互连等工作，起到有线网络中交换机的作用
  - 无线介质（WM）：是 STA 和 STA、STA 和 AP 之间通信时发送无线电波的传输媒质
  - 主干分布式系统（DS）：用来连接不同的基本服务区域（BSS）形成一个扩展服务区（ESA）
- WLAN 的结构：
  - 无中心网络：又称 Ad-hoc 网络，用于多台无线工作站之间的直接通信；该网络不能接入有线网
  - 有中心网络：又称结构化网络，由工作站、无线介质和无线接入点组成；所有工作站在本 BSS 以内都可以直接通信，但在和本 BSS 以外的工作站通信时都要通过本 BSS 的 AP 连接到有线网络来实现
- IEEE 802.11 协议：
  - 802.11 标准
  - 802.11a 标准
  - 802.11b 标准
  - 802.11c 标准
  - 802.11d 标准
  - 802.11e 标准
  - 802.11g 标准

## 中断技术

### 中断概述

- 中断基本原理：
  - 中断的概念：使 CPU 中止正在执行的程序而转去处理特殊事件的操作；这些引起中断的事件称为中断源
  - Intel 系列微处理器的对外中断引脚包括两个申请中断的硬件引脚：INTR 和 NMI
  - 中断结构中的两个标志位 IF 和 TF 和一个特殊的返回指令 IRET/IRETD
- 中断和异常：
  - 中断：
    - 保护模式下，把外部中断称为“中断”，把内部中断称为“异常”
    - 通常在两条指令之间响应中断或异常
    - CPU 最多处理256种中断或异常
    - 中断可以分为可屏蔽中断（INTR）和不可屏蔽中断（NMI）
  - 异常：
    - 异常是 CPU 在执行指令期间检测到不正常的或非法的操作所引起的。异常是不可屏蔽的，每一种异常类别具有不同的异常号码
    - 异常的分类：
      - 故障：故障是在引起异常的指令之前，把异常情况通知给系统的一种情况。故障的特点是可排除
      - 陷阱：陷阱是在引起异常的指令执行之后触发的一种情况；如软中断指令“INT n”和单步异常等
      - 中止：系统出现严重的不可恢复的事件时触发的一种异常，产生中止后，正执行的程序不能被回复执行，系统要重新启动才能恢复正常运行状态
- 中断服务程序：
  - CPU 响应中断时，CPU 暂停当前正在执行的程序转而执行中断服务程序。中断服务程序包括保护现场、处理中断、发送中断结束命令、恢复现场、中断返回几个部分

### 实模式的中断处理

- 中断向量表
- 中断处理过程
- 写中断向量表

### 保护模式的中断处理

- 中断描述符表：
  - 保护模式下响应中断或者处理异常时，CPU 根据中断/异常向量号执行对应的处理程序，把中断类型号作为中断描述符表 IDT 中描述符的索引，取得一个描述符，从中得到中断/异常处理程序的入口地址
  - 每个 CPU 核具有唯一的一个 IDT。IDT 的位置不定，中断描述符表寄存器 IDTR 指示 IDT 在内存中的位置
- 中断和异常的处理过程：:book:
  - 中断和异常响应步骤
  - 跳转到中断服务程序的途径：
    - 通过中断门或陷阱门的跳转
    - 通过任务门的跳转
    - 两种方式的比较：
      - 使用中断门或陷阱门跳转到中断服务程序，处理程序较为简单，不用进行任务切换，可以很快地转移到处理程序，同时还可以对当前任务的状态直接进行访问；但处理程序要负责保护及恢复 CPU 的寄存器等现场，并且处理程序必须存在于当前任务的地址空间中；中断门访问的中断处理程序必须置于全局地址空间中，且必须在特权级0上
      - 使用任务门跳转到中断服务程序，需要进行任务切换，转移到处理程序要花费较长时间；在任务切换过程中，CPU 会自动地保存及恢复寄存器内容等现场
- 中断或异常处理后的返回
- 任务切换

### 可编程中断控制器8259 :book:

- 内部结构：
  - 内部总线缓冲
  - 读写控制逻辑
  - 级联缓冲期/比较器
  - 控制逻辑
  - 中断服务寄存器（ISR）
  - 优先权比较器（PR）
  - 中断请求寄存器（IRR）
  - 中断屏蔽寄存器（IMR）
- 8259中断过程
- 8259的级联
- 8259的编程：
  - 8259是根据收到的 CPU 命令字进行工作的
  - CPU 命令字分为两类：
    - 初始化命令字（ICW1～ICW4）：在系统启动时，由初始化程序来设置；一旦设定，在系统工作过程中就不再改变
    - 操作命令字（OCW1～OCW3）：在计算机系统运行过程中，由 CPU 利用这些控制字来控制8259执行不同的操作；可在初始化之后的任何时刻写入8259，并可多次设置
  - 8259控制信号对应的操作表 :book:
  - 初始化命令字：
    - 初始化过程必须按顺序连续完成
    - 8259的初始化过程： :book:
      - ICW1：写入偶地址端口
      - ICW2：写入奇地址端口
      - ICW3：写入奇地址端口6
      - ICW4：写入奇地址端口
    - 操作命令字：:book:
      - 中断屏蔽操作命令字OCW1：写入奇地址端口
        - 用来实现对中断源的屏蔽功能
      - 优先级循环方式和中断结束方式操作命令字OCW2：写入偶地址端口
        - 设置中断结束方式
        - 设置优先级循环方式
      - 特殊屏蔽方式和中断查询方式操作命令字OCW3：写入偶地址端口
        - 设置和撤销特殊屏蔽方式
        - 查询命令
        - 读取 IRR 或 ISR
      - 8259初始化完毕后，中断屏蔽寄存器 IMR 自动定位奇地址，不必事先写入 OCW3，直接读取奇地址对应的端口即可
- 8259在 PC 中的应用

### 高级可编程中断控制器

- APIC 概述
- LAPIC：
  - 包含了8259和8254的功能
  - 可以响应：
    - 系统中断
    - 处理器间中断
    - 本地中断
- IO APIC：
  - 用来替代传统的8259中断控制器，一般集成在 ICH 芯片组中

## 巩固

- 段描述符格式
- 保护模式下的保护措施
- 数据寻址方式和配合的寄存器和数据段
- 段内（段间）直接（间接）寻址方式
- 块操作指令
- 浮点运算指令
- 8254/8259
- 中断
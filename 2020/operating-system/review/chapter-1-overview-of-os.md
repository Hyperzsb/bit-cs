# 第1章 - 操作系统概论

### 操作系统的组成

从功能上，可以把整个计算机系统划分为四个层次：硬件、操作系统、实用程序和应用程序

- 硬件：由计算机的硬件资源组成（中央处理机、存储器、输入设备和输出设备等）
- 操作系统：是整个计算机系统的管理和控制中心
- 实用程序：包括以下一些程序，它们通常是驻留在磁盘上的。这些程序为用户提供了一个良好的使用计算机系统环境
  - 各种语言的编译程序
  - 文本编辑程序
  - 调试排错程序
  - 连接装配和装入程序
  - 其他还有：标准过程和函数、系统诊断程序、文件加密解密程序和 Internet 浏览器等
- 应用程序：是计算机系统最外层软件，主要负责解决用户的实际问题。如数据库管理软件、计算机辅助设计软件等。

### 操作系统的定义和设计目标

1. **定义**

   - 从计算机系统设计者的角度看，操作系统是计算机软硬件资源的管理和控制程序

   - 从计算机系统用户角度看，配上操作系统的计算机是一台比裸机功能更强、使用更方便简单的虚拟机

2. **目标**

   - 使用户方便、简单地使用计算机系统
   - 使计算机系统能高效地运转

### 操作系统的形成与发展

1. **顺序处理（手工操作阶段）**

   程序员直接与计算机硬件打交道，没有操作系统。需要花费大量时间操作计算机，导致系统昂贵资源的无效使用，原因有：

   - 人工负责计算机的调度

   - 人工负责编排作业的运行顺序

     > 程序，又叫作业。在操作系统中，通常把用户在一次算题过程中要求计算机所做工作的集合叫做一个作业。一个算题任务通常要经历建立、编译、连接装配和运行。把这些相对独立的每一步骤叫做作业步。

2. **简单的批处理系统**

   中心思想是使用一个监控程序软件，各个用户将各自作业的卡片叠或纸代交给机房的操作员，再由操作员将这些作业的卡片或纸带按序成批地放入输入设备，由监控程序自动控制输入设备将各个作业读入到磁带上。之后，监控程序按照顺序自动地把一个个作业装入内存进行处理。

   解决了手工操作阶段的两个问题：

   - 由监控程序处理调度问题，各作业以尽可能快的速度执行，从而不存在空闲的机器时间
   - 由监控程序处理作业编排问题

   这种简单的批处理在硬件结构上有两种不同的控制方式：

   - 早期的联机批处理：作业的输入、计算和输出都是在 CPU 直接控制下进行的。主机的速度降低为慢速输入或输出设备的速度
   - 早期的脱机批处理：为提高 CPU 的利用率，系统增加一台小型卫星机专门用来控制外部设备的输入和输出。实质是用快速的输入和输出设备代替慢速的设备

3. **多道成批处理系统**

   在这一阶段，产生了硬件通道、中断和缓冲技术。使以 CPU 为中心的体系结构转变为以主存为中心的结构。

   > 通道，实际是一种比 CPU 速度较慢、价格较便宜的硬件。它是比小型卫星机更经济的、独立于 CPU 的、专门用于控制输入和输出设备的 I/O 处理机
   >
   > 通道连接着主存和外设，具有与主存直接交换数据的能力

   在主存中同时存放多个作业，使之同时处于运行状态的程序设计方法，叫做多道程序设计

   批处理计算机系统性能指标：

   - 资源利用率：指在给定的时间内，系统中的某一资源，如 CPU 、存储器、外部设备等，实际使用时间或者实际使用容量所占的比率。显然，要提高资源利用率，就必须使资源尽可能忙碌
   - 吞吐量：指单位时间内系统所处理的信息量。通常以每小时或每天所处理的作业个数来度量
   - 周转时间：指从作业进入系统到作业退出系统所经历的时间。即作业在系统中的等待时间加运行时间。而平均周转时间是指系统运行的几个作业周转时间的平均值

   与简单批处理系统相比，多道批处理的实现必须解决好以下三个问题：

   - 存储器的分配和存储保护。使每个程序在主存拥有自己的一个区域，同时限制它们只能正确地访问自己所占的区域，以避免相互干扰和破坏
   - 处理机的管理和调度
   - 系统其他资源的管理和调度

   多道批处理系统仍存在问题：

   - 不能直接控制作业运行。用户一旦把其作业提交给计算机系统，便失去了对作业的控制能力
   - 作业运转周期太长

4. **分时系统**

   分时系统中，一台计算机系统连接有若干台终端，多个用户可以同时在各自的终端上以交互方式使用计算机。分时系统又叫做多用户多任务操作系统

   > 这里的分时，是指将 CPU 的单位时间划分成若干个时间段，每个时间段称为一个时间片，按照时间片轮流把 CPU 分配给各联机用户使用。这样每个用户都能在很短时间内得到计算机的服务。

   分时系统的特点：

   - 同时性：若干个用户可以同时使用计算机
   - 独立性：各用户之间彼此独立地占有一台终端工作，互不干扰
   - 交互性：用户从终端键盘上输入各种控制作业命令，系统相应和处理这些命令，并将处理结果输出显示，用户根据系统输出结果再继续输入
   - 及时性：用户的请求能在较短时间内得到响应

   分时系统与批处理系统的差异：

   - 批处理系统的自动化程度高，通过将各种不同类型的作业进行合理的作业进行合理搭配，大大提高系统资源利用效率。该系统适合处理的作业具有如下性质：比较成熟的、需要耗费较长时间的大型作业
   - 分时系统的目的是对用户请求的快速响应。该系统适合处理短小作业。因此，广泛应用于各种事务处理，并为进行软件开发提供了一个良好环境

5. **实时系统**

   实时，是指计算机对随即发生的外部事件能做出及时的响应和处理。及时是指系统对特定输入做出反应所具有的速度，足以控制发出实时信号的那个设备

   实时系统不同于作业处理系统，它不以作业为处理对象，而以数据或信息作为处理对象，它不接收用户作业，只有几个由外部事件触发的任务

   有两种类型的实时系统：

   - 硬实时：系统的所有可能的延迟是一定的，对于关键的任务，必须在指定时间范围内完成
   - 软实时：即使任务没有在规定时间内完成，也还是允许的

   实时系统的特点：

   - 实时性：系统的正确性不仅依赖于计算的逻辑结果的正确性，而且也依赖于结果产生的及时性
   - 可靠性：实时系统要求硬件和软件措施有非常高的可靠性
   - 确定性

   实时系统的功能：

   - 实时时钟管理
   - 简单的人机对话
   - 过载处理

6. **嵌入式系统**

   是面向用户、产品、应用的系统，可以定义为以应用为中心，以计算机技术为基础、软硬件可裁剪、适应应用系统对功能、可靠性、成本、体积、功耗严格要求的专用计算机系统。凡是将计算机的主机嵌埋在应用系统或设备之中，不为用户所知的计算机应用方式，都是嵌入式应用。嵌入式系统运行的几乎都是实时操作系统

### 操作系统的功能

1. **处理机管理**
2. **存储器管理**
3. **设备管理**
4. **文件管理**

### 操作系统的特性

1. **并发性**

   所谓并发性是指为了增计算机系统的处理能力而采用的一种时间上堆叠操作的技术。并发是指系统中存在若干个逻辑上相互独立的程序或程序段，它们都处于活动状态，并竞争系统的各种资源

2. **共享性**

   支持系统并发性的物质基础是资源共享。为了提高计算机系统的资源利用率，更好地共享系统资源，操作系统的各部分功能设计中采用了各种各样的分配调度算法

3. **虚拟性**

   为了便于用户程序共享计算机系统的各种资源，操作系统把这些资源的一个物理实体变为逻辑上的多个对应物

4. **异步性**

   由于系统资源的共享，有限的资源使并发进程之间产生相互制约关系。系统中的各个进程何时执行、何时暂停以及以怎样的速度向前推进和什么时候完成都是不可预知的。异步性给系统带来潜在的危险，有可能导致系统产生与时间有关的错误。操作系统必须保证有效地防止这些错误的发生。

### 操作系统的进一步发展

1. **个人计算机操作系统**
2. **多处理机操作系统**
3. **网络操作系统**
4. **分布式操作系统**
5. **虚拟化与云计算**

### 用户与操作系统接口

1. **用户与操作系统的操作接口**

   - 命令解释程序

   - 图形用户接口

   - 作业运行的控制命令

2. **系统调用接口**

   所谓系统调用，就是操作系统内提供的一些子程序。编程人员通过使用系统调用命令，向操作系统提出资源请求或获得系统的一些功能服务，以取得操作系统的服务

   CPU 的两种操作方式：

   - 用户态（目态）
   - 核心态（管理态、特权态）

   处理器工作的特权等级决定了所能执行的操作：

   - 执行指令的特权性：指处理机能够执行何种指令
   - 存储器访问的特权性：指现行指令能访问存储的哪些单元

   操作系统程序和用户程序的权限区别：

   - 操作系统程序运行在核心态。在核心态下，允许执行处理机的全部指令集，访问所有的寄存器和存储区
   - 用户程序运行在用户态。在用户态下，只允许执行处理机的非特权指令，访问指定的寄存器和存储区

   系统调用命令包括：

   - 进程控制
   - 文件管理
   - 设备管理
   - 其他服务

### 操作系统的运行方式

由用户态切换到内核态主要发生以下三种情况：

- 中断：又叫外中断，是一些外部设备向 CPU 泄放的一个硬件信号，如各种外部设备的 I/O 完成中断、时钟中断等，与 CPU 执行的指令无关，是异步发生的，分为可屏蔽和不可屏蔽中断。当中断产生时，CPU 响应中断，转入响应的中断处理程序执行
- 异常：又叫陷入，是执行程序自己产生的，是同步发生的，而且是不可屏蔽的。产生的条件是：
  - 由于程序错误，如程序的非法操作码、地址越界、除数为0以及存储器管理中的页面失效等
  - 由于程序请求操作系统服务和请求系统资源等使用系统调用
- 系统调用

由内核态切换回用户态主要发生在以下四种情况：

- 完成中断或异常的处理
- 新进程或线程的启动
- 进程调度选择执行新的进程
- 操作系统向进程发送信号

### 操作系统的设计规范和结构设计

1. **操作系统的设计规范**
   - 系统效率：包括资源利用率、吞吐量和周转时间及响应时间
   - 系统可靠性：指系统能发现、诊断和恢复硬件和软件故障的能力
     - 可靠性 R
     - 可维护性 S
     - 可用性 A
   - 可移植性：指把一个系统从一种硬件环境移植到另一种硬件环境时系统仍能正常工作的能力
   - 可伸缩性：指系统对添加软硬件资源的适应能力，尤其是添加 CPU 资源的能力
   - 兼容性：主要指软件的兼容性
   - 安全性
2. **操作系统的结构设计**
   - 单块式内核：单体式内核，也称宏内核，指整个操作系统的全部或大部分模块运行在内核空间内，模块之间可以直接调用，不用进行内核态到用户态的转换
   - 层次式的结构设计：操作系统可以划分成若干功能独立、更加合理的小模块
   - 基于微内核的 C/S 的设计：操作系统内核只保留最基本的功能（进程线程调度、消息传递、存储器管理和设备驱动等），其他操作系统服务放在用户层以服务的形式实现。
   - 混合结构操作系统内核设计


# 复习笔记

## 数据库管理

### 数据库类型

- SQL 数据库（关系型数据库）
- NoSQL 数据库（非关系型数据库）

### 数据库产品

- 关系型数据库
  - Oracle：闭源，来自 Oracle
  - MySQL：开源，来自 Oracle
  - Microsoft SQL Server：闭源，来自 Microsoft
  - PostgreSQL：开源
  - SQLite：面向嵌入式设备的轻量级数据库
  - DB2：来自IBM
  - Sybase：来自Sybase
- 非关系型数据库
  - 文档数据库
    - MongoDB
  - 键值数据库
    - Redis
  - 图数据库
    - Neo4J
  - 时序数据库
    - InfluxDB

### Microsoft SQL Server 基本架构

功能模块：

- 数据库引擎：用于存储、处理和保护数据的核心服务
- 分析服务：为商业应用程序提供了联机分析处理和数据挖掘等功能
- 报表服务：生成从多种关系数据源和多维数据源提取内容的企业报表
- 集成服务：生成高性能数据集成解决方案，如执行 FTP、电子邮件提醒等工作流
- 通知服务：用于开发和部署可生成并向订阅方发送个性化通知的应用程序

### 系统各级别的主体

**Windows（操作系统）级别**

- Windows 域用户
- Windows 本地组
- Windows 本地用户

**SQL Server（数据库系统）级别**

- 登录（数据库系统用户）
  - sa：系统管理员 (sa) 是为向后兼容而提供的特殊登录。默认情况下，它指派给固定服务器角色 sysadmin，并不能进行更改
- 服务器角色
  - sysadmin：可以在数据库系统中执行任何操作。将固定服务器角色 sysadmin 的任何成员都映射到每个数据库内称为 dbo 的一个特殊用户上。另外，由固定服务器角色 sysadmin 的任何成员创建的任何对象都自动属于 dbo
  - serveradmin：可以配置、关闭服务器
  - setupadmin：配置数据库系统的启动过程
  - dbcreator：可以创建、更改和删除数据库
  - diskadmin：可以管理磁盘文件
  - ...

**数据库级别**

- 数据库用户：

  - dbo：无法删除该用户，且此用户始终出现在每个数据库中

  - guest：该 用户在数据库创建时即被建立，且不能被删除，但可以被禁用

- 数据库角色

  - public：一个特殊的数据库角色，每个数据库用户都属于它
    - 无法将用户指派给该角色，因为默认所有用户都属于它
    - 包含在包括系统数据库（master、msdb、tempdb、model）在内的所有数据库中
    - 无法除去
  - db_owner：在该数据库中拥有全部权限
  - db_accessadmin：可以添加或删除用户 ID
  - db_securityadmin：可以管理全部对象权限

- 应用程序角色

### 架构

是形成单个命名空间的数据库实体的集合。命名空间是一个集合，其中每个元素的名称都是唯一的

SQL Server 添加了默认架构

用户和架构分离的优点：

- 多个用户可以通过角色成员身份共用一个架构
- 简化了删除数据库用户的操作

### 系统实例

默认实例仅由运行该实例的计算机的名称唯一标识，它没有单独的实例名。如果应用程序在请求连接 SQL Server 时只指定了计算机名，则 SQL Server 客户端组件将尝试连接这台计算机上的数据库引擎默认实例。一台计算机只有一个默认实例

默认实例外，所有数据库引擎实例都由安装该实例的过程中指定的实例名标识。应用程序必须提供准备连接的计算机的名称和命名实例的实例名。**计算机名和实例名以格式 computer_name\instance_name 指定**

### 系统数据库

- master：master 数据库记录 SQL Server 系统的所有系统级信息。这包括实例范围的元数据（例如登录帐户）、端点、链接服务器和系统配置设置，同时也记录了所有其他数据库的存在、数据库文件的位置以及 SQL Server 的初始化信息，**所以 master 数据库必须存在**
- model：**用作在 SQL Server 实例上创建的所有数据库的模板**
- msdb：由 SQL Server 代理用于计划警报和作业，也可以由其他功能（如 Service Broker 和数据库邮件）使用
- tempdb：该数据库是一个全局资源，包括显式创建的临时用户对象、数据库引擎创建的内部对象、由使用已提交读的数据库中数据修改事务生成的行版本。**每次启动 SQL Server 时都会重新创建 tempdb，从而在系统启动时总是保持一个干净的数据库副本**。在断开联接时会自动删除临时表和存储过程，并且在系统关闭后没有活动连接。**不允许对 tempdb 进行备份和还原操作**

### 文件和文件组

1. 数据文件

- 主要数据文件：`.mdf` 一个数据库只有一个主要数据文件，包含数据库的启动信息，并指向数据库中的其他文件。用户数据和对象可存储在此文件中，也可以存储在次要数据文件
- 次要数据文件：`.ndf` 一个数据库可以有零个或多个次要数据文件，次要文件可用于将数据分散到多个磁盘上
- 事务日志文件：`.ldf` 保存用于恢复数据库的日志信息

> **每个 SQL Server 数据库至少具有两个操作系统文件：一个数据文件和一个日志文件**

2. 文件组

**每个数据库有一个主要文件组**。此文件组包含主要数据文件和未放入其他文件组的所有次要文件。可以创建用户定义的文件组，用于将数据文件集合起来，以便于管理、数据分配和放置

通过将数据文件分散到不同磁盘上可以提高系统性能

如果在数据库中创建对象时没有指定对象所属的文件组，对象将被分配给默认文件组 Primary（即使指定了自定义文件组，系统对象将仍然分配给 Primary 文件组）

3. 逻辑文件名和物理文件名

4. 数据页面、数据盘区

一个数据页面大小为8KB，**是数据库中使用的最小数据单元**，包含一个96Byte的页面头

一个数据盘区由8个数据页面构成（8*8KB），盘区是表和索引分配存储空间的单位。分为混合区（表和索引混合储存）和统一区（只有一种对象数据）

## Transact-SQL

1. 标识符：常规标识符、分隔标识符
2. 对象名：`[ [ [ server. ] [ database ] . ] [ schema_name ] . ] object_name`

3. 内置数据类型，用户自定义数据类型

4. 存储过程：

   - 允许程序模块化
   - 执行更快
   - 减少网络流量
   - 增强安全性

   系统存储过程以 `sp_` 开头，且无需完全限定名来引用。虽然当前数据库中可能存在带 sp_ 前缀的用户创建的存储过程，但总会先检查 master 数据库；如果用户创建的存储过程与系统存储过程同名，则永远不执行用户创建的存储过程

5. 函数
6. 游标
7. 错误信息
8. 触发器
   - 触发器是自动的
   - 触发器可以强制限制，这些限制比用 CHECK 约束所定义的更复杂。与 CHECK 约束不同的是，触发器可以引用其它表中的列
   - deleted 表：用于存储 DELETE 和 UPDATE 语句所影响的行的复本。在执行 DELETE 或 UPDATE 语句时，行从触发器表中删除，并传输到 deleted 表中。Deleted 表和触发器表通常没有相同的行
   - inserted 表：用于存储 INSERT 和 UPDATE 语句所影响的行的副本。在一个插入或更新事务处理中，新建行被同时添加到 inserted 表和触发器表中。Inserted 表中的行是触发器表中新行的副本
   - instead of 触发器：**包含多个基表的视图必须使用 INSTEAD OF 触发器来支持引用表中数据的插入、更新和删除操作。非INSTEAD OF触发器只能基于基表创建，且均是AFTER类型**


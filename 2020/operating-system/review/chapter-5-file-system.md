# 第5章 - 文件系统

### 文件和文件系统

1. **文件**

   - 文件的定义：从用户角度看，文件是存储在外部存储器的具有符号名的相关信息的集合

   - 文件属性：

     - 文件名：用户为其文件定义的可读的符号
     - 文件标识：每个文件都有一个唯一的数字值，它是操作系统管理文件的唯一的标识
     - 文件类型：由文件扩展名给出
     - 文件位置
     - 文件大小
     - 文件的保护方式
     - 文件的创建或修改日期等

     这些信息构成了文件控制块（File Control Block, FCB）。显然文件控制块包含了文件的说明信息和管理控制信息。由此可见，一个文件由两部分组成：文件控制块和文件体。操作系统通过文件控制块管理文件，而用户关系和使用的是文件体，即文件的实际内容

     DOS 系统的文件控制块:book:

2. **文件的分类**

   在 UNIX 系统中，为了方便用户操作文件，按文件的组织和处理方式划分为如下三类：

   - 普通文件：这种文件包括系统文件、应用程序文件、库文件，也包括用户的各种文件。可以是 ASCII 码组成的字符文件，也可以是二机制代码构成的文件。通常把由 ASCII 字符组成的文件叫文本文件
   - 目录文件：目录文件是用来维护文件系统结构的文件。通过目录文件，系统可以检索普通文件。由于目录文件也是由字符序列组成的，因此对它的处理与普通文件相同
   - 特别文件：指系统中所有的输入、输出和输入/输出型设备，以及其他一些特殊文件。把输入、输出设备（中断、打印机）叫做字符型特别文件。把输入/输出型设备（磁带、磁盘、光盘）叫做块特别文件。这些文件与普通文件相同，都要查找目录、验证使用权限、进行读或写等，只是系统把对特别文件的操作转为对不同设备的操作

3. **文件系统**

   文件系统是操作系统中管理文件的软件机构

   一个理想的文件系统应具备以下功能：

   - 管理磁盘、磁带等组成的文件存储器
   - 实现用户的按名存取
   - 提供灵活多样的文件结构和存取方法，便于用户对文件进行存储和加工处理
   - 提供一套方便、简单的文件操作命令
   - 保证文件信息的安全性
   - 便于文件的共享

### 文件目录结构

所谓文件目录是指记录文件的名字及其存放物理地址的一张映射表，表中包括了很多文件控制块

1. **一级目录结构**

   可以简单地理解为文件名与其存储位置的映射表。为文件存储器上保存的全部文件建立一张一维目录表:book:

   这种目录结构虽然简单，但不允许不同的文件具有相同的文件名，否则将出现二义性。另外，当文件较多时，查找一个文件花费时间太多。因此，这种目录只在低档微机或早期的小型机上使用

2. **二级目录结构**

   为解决文件重名的问题，可采用二级目录结构，即为每个用户建立一个独立的目录，叫做用户文件目录。系统维护一个主文件目录，记录各用户名字及用户文件目录所在的物理地址:book:

   二级目录结构解决了命名冲突，但当系统中文件很多时，存取速度仍然较慢，而且无法实现文件共享

3. **多级目录结构**

   - 树形目录

   - 当前目录

   - 无环图目录结构

     与上述目录结构相比，无环图型目录结构更便于共享文件和子目录。共享文件在磁盘上只存在一个副本，文件的任何改变都会对其他用户可见。通常采用硬链接和符号链接来实现。在创建链接时要避免出现环，有环的图会使操作变得很复杂

   多级目录的优点：

   - 层次结构清晰，便于管理和保护
   - 有利于文件分类
   - 解决文件重名问题
   - 提高文件检索速度
   - 能进行存取权限的控制

   多级目录的缺点：

   - 管理开销大
   - 同时按路径名查找一个文件需逐层检查多级目录，多次访盘，影响文件的访问速度。而且只能采用绕道和链接的方法实现文件共享

4. **目录表的保存**

   目录表按照卷构造和保存，保存方法有两种，一种是放在卷的固定区域，如 DOS 的根目录表；另一种是把目录表作为普通文件保存在文件数据区中。后者更适合文件系统的特点，如 UNIX 和 Linux 等

   由于目录表按卷构造，相应的目录表及其信息保存在同一外存卷中，因此可通过物理地搬动这些卷，将文件从一个系统转移到另一个系统。由于它们可以脱机保存，从而大大扩充了文件存储器的空间

### 文件的逻辑结构和存取方法

文件结构是指文件的组织形式。文件系统的设计者通常从两种不同的观点去研究文件的结构：

- 从用户使用的角度：目的是为用户提供一种逻辑结构清晰、使用简单的文件结构，用户将按照这种形式去存储、检索和使用文件
- 从系统实现的角度：研究存放在存储介质上的实际文件，即物理文件，目的是选择一些工作性能良好，设备利用率高、存取速度快的物理文件结构，系统将按照这种结构选择文件存储设备，存储信息并控制设备上的信息传输

文件系统的重要作用之一就是在用户逻辑文件和物理文件之间建立映射，实现二者之间的相互转换

文件的逻辑结构通常分为两种形式，一种是无结构的字节流式文件；一种是有结构的记录式文件，记录式文件又划分为定长式和变长式。UNIX 和 Windows 就是以无结构的字节流形式组织文件和处理文件的

把文件的存取方法分为两大类：

- 顺序存取

  对文件的存取都是在前一次存取的基础上进行的，是最简单的存取方法。顺序存取就是严格按照字节或记录出现的先后次序顺序依次存取的

- 直接存取

  直接存取又叫做随机存取。它允许用户随意的存取文件中的一个记录，而不管上一次存取的是那个记录

  对于定长记录式文件，直接存取方便且高效；而对于变长记录式文件，则十分低效。故对于变长记录文件，通常采用顺序存取法

### 文件的物理结构

文件的物理结构是指一个文件在文件存储器上的存储方式及其与文件逻辑结构的关系

1. **连续文件**

   连续文件又叫做顺序文件，是最简单的文件物理结构。它是把逻辑上连续的文件信息存储在连续的物理块中的一种组织方式:book:

   优点：

   - 实现简单：只要记住文件的第一块所在位置及文件包括的块数即可
   - 支持顺序存取和随机存取：只有这种结构的文件才适合存放在磁带上
   - 存取速度快：只要访问一次文件的管理信息，就可方便地存取到任一记录

   缺点：

   - 不灵活：要求在文件创建时，就给出文件的最大长度，且一旦创建就不允许动态修改
   - 容易产生碎片：当文件被删除时，文件存储空间可能出现许多小的无法利用的空洞。这种结构适合存储操作系统和实用程序一类长度不变的系统文件

2. **链接（或串联）文件**

   如果用户基本上是顺序存取文件中的信息，为了克服采用连续结构而产生的碎片问题，可以将逻辑上连续的记录分配到不连续的物理块中（链式结构）

   优点：

   - 允许文件动态增长，增加了使用的灵活性

   缺点：

   - 只能顺序存取

   为克服链接文件不能顺序存取的缺点，可以把指针字从各文件物理块中取出，放在一个表中或在存储器中建一个索引:book:

   DOS 使用这种方式分配和管理磁盘空间，并将此表叫做盘文件映射表或文件分配表（File Allocation Table, FAT）

   利用文件分配表，不必访问磁盘就能很快定位一个记录的位置。该方式的缺点是在系统工作期间，整个表必须在主存

3. **索引文件**

   为方便用户存取文件，为存储的文件建立一个索引表，该表指出文件的逻辑块与物理块的映射关系。将文件索引表所在物理块记录在文件目录表中:book:

   多级索引表:book:

   优点：

   - 允许文件动态修改，增加了文件的灵活性
   - 允许用户按照要求，直接对文件进行存取

   缺点：

   - 由于使用了索引表，增加了存储器空间的开销
   - 降低了文件的存取速度：每个文件的存取至少需要访问外部存储器两次，一次访问索引表，一次访问文件信息

4. **索引顺序文件**

   它将顺序文件中的所有记录分成若干组，并为其建立索引表。每组第一个记录建立一个索引项，其他记录不建立索引项

### 文件的存储介质

1. **文件卷的结构**:book:
2. **磁带**:book:
3. **文件存储器的主要参数**:book:

### 文件记录的组块与分解

把多个逻辑记录放在一个物理块中，也允许一个逻辑记录跨块存放

大大提高文件存储器的利用率，另一方面减少了启动 I/O 操作的次数，提高系统效率

1. **记录的组块**

   把多个逻辑记录存放在一个物理块中的工作叫做记录的组块。把一个块中存放的逻辑记录个数叫做块因子

   进行组块操作时，必须使用主存缓冲区。当用户要写记录到磁盘时，系统为它分配一个主存缓冲区，将要写记录先写入主存缓冲区。当缓冲区写满时，才真正启动磁盘进行实际写，从而大大降低了启动磁盘的次数，延长了磁盘介质的寿命

2. **记录的分解**

   从一个物理块中将一个逻辑记录分离出来的工作叫做记录的分解

### 文件存储器存储空间的管理

1. **空白文件目录**

   所谓空白文件，是指一个连续未用的空闲块区。系统为所有这些空白文件建立一张表，叫做空白文件目录。每个空白文件占用其中一个表目:book:

   这是一种最简单的空闲区管理技术，适合于文件的静态分配（即连续结构的文件分配）

2. **空闲块链**

   把所有空闲块链接成一个链，即空闲块链，主存保留一个链头指针

   空白块成组链表:book:

3. **位映像表或位示图**

   适合文件静态分配和动态分配的最简单管理方法是采用位映像表。位映像表使用一个位向量，磁盘中的每个块占用其中的一位

   优点：

   - 比较容易找到一个或几个连续的空闲块
   - 这种位映像表尺寸固定，通常又比较小，可以保存在主存中，从而可以高速地实现文件的分配和回收工作